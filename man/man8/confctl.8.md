# confctl 8                       2020-11-01                             master

## NAME
`confctl` - Nix deployment management tool

## SYNOPSIS
`confctl` [*global options*] *command* [*command options*] [*arguments...*]

## DESCRIPTION
`confctl` is a Nix deployment configuration management tool. It can be used to
build and deploy *NixOS* and *vpsAdminOS* machines.

## SOFTWARE PINS
Each deployment target in `vpsfree-cz-configuration` uses predefined software
packages like `nixpkgs`, `vpsadminos` and possibly other components. These
packages are pinned to particular versions, e.g. specific git commits.

Software pins are generated by `confctl` as JSON files and read by `Nix` while
building target systems. Pinned packages can be managed in two ways: as files
and as channels. Each file contains a set of packages, their URL, revision
and checksum. There is usually one JSON file for every deployed machine. To make
administration simpler, software packages in files can use channels. Channels
define software pins just like files, but they're connected with software
packages in files that use them: when a channel is changed, all packages that
use it are changed as well. Software packages in one file can use various
channels, but each package can belong to only one channel.

See the `confctl swpins` command family.

## PATTERNS
`confctl` commands accept patterns instead of names. These patterns work
similarly to shell patterns, see
<http://ruby-doc.org/core/File.html#method-c-fnmatch-3F> for more
information.

## COMMANDS
`confctl init`
  Create a new configuration in the current directory. The current directory
  is set up to be used with `confctl`

`confctl add` *name*
  Add new deployment.

`confctl rediscover`
  Auto-discover deployments within the `cluster/` directory and generate a list
  of their modules in `cluster/cluster.nix`.

`confctl ls` [*options*] [*host-pattern*]
  List matching hosts available for deployment.

    `--show-trace`
      Enable traces in Nix.

    `--managed` `y`|`yes`|`n`|`no`|`a`|`all`
      The configuration can contain deployments which are not managed by confctl
      and are there just for reference. This option determines what kind of
      deployments should be listed.

    `-a`, `--attr` *attribute*`=`*value* | *attribute*`!=`*value*
      Filter deployments by selected attribute, which is either tested for
      equality or inequality. Any attribute from configuration module
      `cluster.<name>` can be tested.

    `-t`, `--tag` *tag*|`^`*tag*
      Filter deployments that have *tag* set. If the tag begins with `^`, then
      filter deployments that do not have *tag* set.

`confctl build` [*host-pattern*]
  Build matching hosts.

    `--show-trace`
      Enable traces in Nix.

    `-a`, `--attr` *attribute*`=`*value* | *attribute*`!=`*value*
      Filter deployments by selected attribute, which is either tested for
      equality or inequality. Any attribute from configuration module
      `cluster.<name>` can be tested.

    `-t`, `--tag` *tag*|`^`*tag*
      Filter deployments that have *tag* set. If the tag begins with `^`, then
      filter deployments that do not have *tag* set.

    `-y`, `--yes`
      Do not ask for confirmation on standard input, assume the answer is yes.

`confctl deploy` [*host-pattern*] [`boot`|`switch`|`test`|`dry-activate`]
  Build and deploy matching hosts. *switch-action* is the argument to
  `switch-to-configuration` called on the target host. The default action
  is `switch`.

    `--show-trace`
      Enable traces in Nix.

    `-a`, `--attr` *attribute*`=`*value* | *attribute*`!=`*value*
      Filter deployments by selected attribute, which is either tested for
      equality or inequality. Any attribute from configuration module
      `cluster.<name>` can be tested.

    `-t`, `--tag` *tag*|`^`*tag*
      Filter deployments that have *tag* set. If the tag begins with `^`, then
      filter deployments that do not have *tag* set.

    `-y`, `--yes`
      Do not ask for confirmation on standard input, assume the answer is yes.

`confctl gen-data vpsadmin all`
  Generate all required data files from vpsAdmin API.

`confctl gen-data vpsadmin containers`
  Generate container data files from vpsAdmin API.

`confctl gen-data vpsadmin network`
  Generate network data files from vpsAdmin API.

`confctl swpins file ls` [*file-pattern* [*sw-pattern*]]
  List existing files with pinned software packages.

`confctl swpins file git add` *file-pattern* *sw* *url* *ref*
  Add software package *sw* to files matching *file-pattern*. *url* is an URL to
  the git repository, *ref* is a git commit or reference, e.g. `refs/heads/master`
  or `refs/tags/v1.0.0`.

`confctl swpins file git set`
  Update matching software packages to use a different git reference. If the
  file belongs to a channel, changed packages are detached from the channel, but
  other packages are left alone.

  See available subcommands.

`confctl swpins file git set ref` *file-pattern* *sw-pattern* *ref*
  Update matching software packages to git commit or reference.

`confctl swpins file git set branch` *file-pattern* *sw-pattern* *branch*
  Update matching software packages to git branch, i.e. `refs/heads/`*branch*.

`confctl swpins file git set tag` *file-pattern* *sw-pattern* *tag*
  Update matching software packages to git tag, i.e. `refs/tags/`*tag*.

`confctl swpins file git del` *file-pattern* *sw-pattern*
  Remove matching software packages.

`confctl swpins file channel use` *file-pattern* *channel-pattern*
  Attach matching files to matching channels.

`confctl swpins file channel detach` *file-pattern* *channel-pattern*
  Detach matching files from matching channels.

`confctl swpins channel ls` [*channel-pattern* [*sw-pattern*]]
  List existing channels with pinned software packages.

`confctl swpins channel new` *channel*
 Create a new empty channel.

`confctl swpins channel rename` *channel* *new-channel*
  Rename *channel* to *new-channel*. All files using *channel* are switched over
  to *new-channel*.

`confctl swpins channel del` *channel-pattern*
 Delete maching channels.

   `--[no-]keep-specs`
     Determines whether software packages managed by the channel are deleted
     from files using the deleted channel. They are not removed by default.

`confctl swpins channel git set`
  Update matching software packages to use a different git reference. All
  packages that use this channel are updated as well.

  See subcommands for more information.

`confctl swpins channel git set ref` *channel-pattern* *sw-pattern* *ref*
  Update matching software packages to git commit or reference.

`confctl swpins channel git set branch` *channel-pattern* *sw-pattern* *branch*
  Update matching software packages to git branch, i.e. `refs/heads/`*branch*.

`confctl swpins channel git set tag` *channel-pattern* *sw-pattern* *tag*
  Update matching software packages to git tag, i.e. `refs/tags/`*tag*.

`confctl docs start`
  Start HTTP server at `http://localhost:8000` to serve rendered documentation.

`confctl docs stop`
  Stop the HTTP server started by `confctl docs start`.

## BUGS
Report bugs to https://github.com/vpsfreecz/confctl/issues.

## ABOUT
`confctl` is developed for purposes of [vpsFree.cz](https://vpsfree.org) and
its cluster [configuration](https://github.com/vpsfreecz/vpsfree-cz-configuration).
